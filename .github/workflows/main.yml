---  # trunk-ignore(checkov)
name: CI

on:
  push:
  pull_request:

concurrency:
  group: ${{ github.workflow }}

jobs:
  get-version:
    name: get-version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.versions.outputs.version }}
      version_rpm: ${{ steps.versions.outputs.version_rpm }}
      storm_version: ${{ steps.versions.outputs.storm_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get versions
        id: versions
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          VERSION=$(git describe --tags --dirty)
          VERSION_RPM=$(git describe --tags --abbrev=0)
          STORM_VERSION=1.12.0
          {
            echo "version=$VERSION"
            echo "version_rpm=$VERSION_RPM"
            echo "storm_version=$STORM_VERSION"
          } >> "$GITHUB_OUTPUT"

  build-rpm:
    name: build-rpm (${{ matrix.distro }})
    needs: get-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - distro: fedora-39
            container: fedora:39
            spec: teapot-fedora.spec
            artifact_suffix: rpm_fedora_39
            rpm_glob: "*.fc39.*.rpm"
          - distro: rockylinux-9.3
            container: rockylinux:9.3
            spec: teapot-rockylinux.spec
            artifact_suffix: rpm_rockylinux_9.3
            rpm_glob: "*.rocky9.*.rpm"
          - distro: almalinux-9.4
            container: almalinux:9.4
            spec: teapot-almalinux.spec
            artifact_suffix: rpm_almalinux_9.4
            rpm_glob: "*.alma9.*.rpm"
    container:
      image: ${{ matrix.container }}
    steps:
      - name: Install build requisites
        run: |
          dnf -y update
          dnf -y install rpmdevtools systemd-rpm-macros rpmlint rsync git python3-pip wget rpm-build cpio
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up RPM build environment
        run: rpmdev-setuptree
      - name: Copy spec file
        run: cp rpm/${{ matrix.spec }} ~/rpmbuild/SPECS/teapot.spec
      - name: Create source tarball
        run: |
          mkdir teapot-${{ needs.get-version.outputs.version_rpm }}
          rsync -av --progress ./* teapot-${{ needs.get-version.outputs.version_rpm }}/ --exclude teapot-${{ needs.get-version.outputs.version_rpm }}
          tar cfz teapot-${{ needs.get-version.outputs.version_rpm }}.tar.gz teapot-${{ needs.get-version.outputs.version_rpm }}
          rm -r teapot-${{ needs.get-version.outputs.version_rpm }}
          mv teapot-${{ needs.get-version.outputs.version_rpm }}.tar.gz ~/rpmbuild/SOURCES/
      - name: Build RPM
        run: |
          rpmbuild -ba \
            --define "version_ ${{ needs.get-version.outputs.version_rpm }}" \
            --define "storm_version ${{ needs.get-version.outputs.storm_version }}" \
            ~/rpmbuild/SPECS/teapot.spec
      - uses: actions/upload-artifact@v4
        with:
          name: teapot-${{ needs.get-version.outputs.version }}_${{ matrix.artifact_suffix }}
          path: /github/home/rpmbuild/RPMS/x86_64/teapot-${{ matrix.rpm_glob }}

  build-deb:
    name: build-deb
    needs: get-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install build requisites
        run: |
          sudo apt -y update
          sudo apt -y install dpkg-dev build-essential devscripts fakeroot
          sudo apt -y install debhelper-compat=13 dh-python python3 python3-pip
          sudo apt -y install python3-setuptools wget rpm2cpio cpio
      - name: Build deb
        run: |
          export VERSION_DEB="${{ needs.get-version.outputs.version_rpm }}"
          export STORM_VERSION=1.12.0
          dch --newversion "${VERSION_DEB}-1" --distribution unstable "Release ${VERSION_DEB}"
          dch --release ""
          dpkg-buildpackage -us -uc -b
          cp ./../teapot*.deb .
      - uses: actions/upload-artifact@v4
        with:
          name: teapot-${{ needs.get-version.outputs.version }}_debian_all
          path: teapot_*1_all.deb

  containers:
    name: containers
    needs: [get-version, build-rpm, build-deb]
    runs-on: ubuntu-latest
    env:
      REGISTRY: ghcr.io
      ORG: intertwin-eu
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: teapot-${{ needs.get-version.outputs.version }}_rpm_fedora_39
          path: /home/runner/work/teapot/teapot/robot
      - uses: actions/download-artifact@v4
        with:
          name: teapot-${{ needs.get-version.outputs.version }}_debian_all
          path: /home/runner/work/teapot/teapot/robot
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - name: Prepare certs and configs
        env:
          TEAPOT_CA_CRT: ${{ secrets.TEAPOT_CA_CRT }}
          TEAPOT_CA_KEY:  ${{ secrets.TEAPOT_CA_KEY }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          ALISE_CLIENT_SECRET: ${{ secrets.ALISE_CLIENT_SECRET }}
        run: |
          cd robot
          echo "$TEAPOT_CA_CRT" > Teapot-testing.crt
          echo "$TEAPOT_CA_KEY" > Teapot-testing.key
          chmod 777 cert-gen.sh

          # Teapot
          ./cert-gen.sh teapot
          envsubst < ./../keycloak-setup/test_client_config.json > test_client_config_final.json
          docker buildx build \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/teapot:cache \
            --cache-to type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/teapot:cache \
            --push --tag ${{ env.REGISTRY }}/${{ env.ORG }}/teapot:latest \
            -f teapot-fedora.dockerfile .
          rm teapot.crt teapot.key

          # Teapot-ubuntu
          ./cert-gen.sh teapot-ubuntu
          docker buildx build \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/teapot-ubuntu:cache \
            --cache-to type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/teapot-ubuntu:cache \
            --push --tag ${{ env.REGISTRY }}/${{ env.ORG }}/teapot-ubuntu:latest \
            -f teapot-ubuntu.dockerfile .

          # Robot-testing
          docker buildx build \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/robot-testing:cache \
            --cache-to type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/robot-testing:cache \
            --push --tag ${{ env.REGISTRY }}/${{ env.ORG }}/robot-testing:latest \
            -f robot.dockerfile .

          # ALISE
          cd alise
          cp ./../Teapot-testing.crt Teapot-testing.crt
          envsubst < alise.conf > alise_out.conf
          rm alise.conf && mv alise_out.conf alise.conf
          docker buildx build \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/alise:cache \
            --cache-to type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/alise:cache \
            --push --tag ${{ env.REGISTRY }}/${{ env.ORG }}/alise:latest \
            -f Dockerfile .

          # building Keycloak container
          cd ./../../keycloak-setup/
          echo "$TEAPOT_CA_CRT" > Teapot-testing.crt
          echo "$TEAPOT_CA_KEY" > Teapot-testing.key
          ./../robot/cert-gen.sh keycloak
          cp teapot.crt keycloak.pem
          cp teapot.key keycloak-key.pem
          docker buildx build \
            --cache-from type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/keycloak:cache \
            --cache-to type=registry,ref=${{ env.REGISTRY }}/${{ env.ORG }}/keycloak:cache \
            --push --tag ${{ env.REGISTRY }}/${{ env.ORG }}/keycloak:latest \
            -f Dockerfile .

  test:
    name: test
    needs: [get-version, containers]
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/intertwin-eu/robot-testing:latest
      credentials:
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.TOKEN }}
    services:
      keycloak:
        image: ghcr.io/intertwin-eu/keycloak:latest
        credentials:
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.TOKEN }}
      alise:
        image: ghcr.io/intertwin-eu/alise:latest
        credentials:
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.TOKEN }}
      teapot:
        image: ghcr.io/intertwin-eu/teapot:latest
        credentials:
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.TOKEN }}
      teapot-ubuntu:
        image: ghcr.io/intertwin-eu/teapot-ubuntu:latest
        credentials:
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Test Teapot
        run: |
          eval "$(oidc-agent)"
          envsubst < keycloak-setup/test_client_config.json > keycloak-setup/test_client_config_final.json
          envsubst < keycloak-setup/alise_client_config.json > keycloak-setup/alise_client_config_final.json
          echo "" > pw-file
          oidc-gen --flow password -f keycloak-setup/test_client_config_final.json --op-username test-user1 --op-password secret1  --prompt none --pw-file pw-file test-user1
          oidc-gen --flow password -f keycloak-setup/test_client_config_final.json --op-username test-user2 --op-password secret2  --prompt none --pw-file pw-file test-user2
          oidc-gen --flow password -f keycloak-setup/test_client_config_final.json --op-username test-user3 --op-password secret3  --prompt none --pw-file pw-file test-user3
          oidc-gen --flow password -f keycloak-setup/test_client_config_final.json --op-username test-user4 --op-password secret4  --prompt none --pw-file pw-file test-user4
          oidc-gen --flow password -f keycloak-setup/alise_client_config_final.json --op-username alise-user1 --op-password secret1  --prompt none --pw-file pw-file alise-user1
          oidc-gen --flow password -f keycloak-setup/alise_client_config_final.json --op-username alise-user2 --op-password secret2  --prompt none --pw-file pw-file alise-user2
          robot --outputdir /__w/teapot/teapot/robot/output/ /__w/teapot/teapot/robot/teapot-tests.robot
        env:
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          ALISE_CLIENT_SECRET: ${{ secrets.ALISE_CLIENT_SECRET }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-tests
          path: /__w/teapot/teapot/robot/output

  generate_report:
    if: always()
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: robot-tests
          path: /home/runner/work/teapot/teapot/reports/
      - name: Send report to commit
        uses: joonvena/robotframework-reporter-action@v2.4
        with:
          gh_access_token: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Create Release
    needs: [get-version, build-rpm, build-deb, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/
      - name: Unzip all artifacts
        run: |
          mkdir -p rpms/
          mkdir -p debs/
          find artifacts/ -name "*.rpm" -exec cp {} rpms/ \;
          find artifacts/ -name "*.deb" -exec cp {} debs/ \;
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            rpms/*.rpm
            debs/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}